# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

This is an RPG Maker MZ game project titled "Pharmageddon". RPG Maker MZ is a game development engine that uses JSON data files for game content and JavaScript for game logic and plugins.

## Key Technologies

- **Engine**: RPG Maker MZ v1.9.1
- **Runtime**: NW.js (Node-Webkit) for desktop deployment
- **Graphics**: PixiJS (WebGL renderer)
- **Script Loading**: Sequential loading via `js/main.js`
- **Data Format**: JSON files in `data/` directory

## Setup

**Critical first step**: After cloning, run `git lfs install` to enable Git LFS tracking for binary assets (images, audio, fonts). Without this, you'll get LFS pointer files instead of actual assets, causing the game to fail loading resources.

## Architecture

### Script Loading Order

The game follows a strict loading sequence defined in `js/main.js`:
1. Core libraries (PixiJS, pako, localforage, effekseer, vorbisdecoder)
2. Engine core (`rmmz_core.js`)
3. Game managers (`rmmz_managers.js`)
4. Game objects (`rmmz_objects.js`)
5. Scene management (`rmmz_scenes.js`)
6. Sprites (`rmmz_sprites.js`)
7. Windows/UI (`rmmz_windows.js`)
8. Plugin loader (`plugins.js`)

After all scripts load, `PluginManager.setup($plugins)` initializes plugins, then `Scene_Boot` starts the game.

### Data Structure

Game content is stored as JSON in the `data/` directory. **All these files are generated by RPG Maker editor - never edit directly**.

- **Maps**: `MapXXX.json` (tile-based level data, events, NPC placement)
  - Each map is a separate file: `Map001.json`, `Map002.json`, etc.
  - Contains: tiles, events, encounters, BGM, parallax settings
  - `MapInfos.json`: Map hierarchy, names, and tree structure
- **Database** (core game definitions):
  - `Actors.json`: Player characters (stats, class, equipment, sprites)
  - `Classes.json`: Character classes (skill learning, stat curves)
  - `Skills.json`: Magic/abilities (effects, animations, costs)
  - `Items.json`: Consumables and key items
  - `Weapons.json`, `Armors.json`: Equipment definitions
  - `States.json`: Status effects (poison, buffs, etc.)
  - `Enemies.json`: Enemy stats and behaviors
  - `Troops.json`: Enemy formations for battles
- **Configuration**:
  - `System.json`: Critical game settings (title, resolution, party, BGM, variables, switches, fonts, UI settings)
  - `Tilesets.json`: Tileset definitions and passability rules
  - `Animations.json`: Battle animations and effects
  - `CommonEvents.json`: Reusable event logic

### Plugin System

Custom plugins live in `js/plugins/` and are registered in `js/plugins.js` (auto-generated by RPG Maker editor). Available plugins:
- `AltSaveScreen.js`: Custom save screen UI
- `AltMenuScreen.js`: Custom menu screen UI
- `TextPicture.js`: Display text as pictures
- `ButtonPicture.js`: Picture-based button functionality

**Important**: `plugins.js` is auto-generated. Enable/disable plugins using RPG Maker's Plugin Manager, not by editing this file directly.

### Asset Directories

- `img/`: Graphics organized by type
  - `battlebacks1/`, `battlebacks2/`: Battle backgrounds
  - `characters/`: Character sprites for map movement
  - `faces/`: Character portraits for dialogues
  - `sv_actors/`, `sv_enemies/`: Side-view battle sprites
  - `enemies/`: Front-view enemy graphics
  - `tilesets/`: Tileset images for maps
  - `titles1/`, `titles2/`: Title screen images
  - `parallaxes/`: Parallax scrolling backgrounds
  - `pictures/`: In-game picture resources
  - `system/`: UI elements and system graphics
- `audio/`: Sound and music organized by type
  - `bgm/`: Background music (loops)
  - `bgs/`: Background sounds (ambient loops)
  - `me/`: Music effects (short jingles)
  - `se/`: Sound effects (one-shots)
- `fonts/`: Custom fonts (`mplus-2p-bold-sub.woff`, `Valorax-lg25V.otf`) - tracked via Git LFS
- `movies/`: Video files for cutscenes
- `effects/`: Effekseer particle effects (.efkefc files)
- `icon/`: Application icon
- `save/`: Save game files (currently tracked in git)

## Development Workflow

### Running the Game

**Browser**: Open `index.html` in a web browser. Note that the game requires local file access (XHR to local files), which some browsers block by default. Chrome/Edge with `--allow-file-access-from-files` flag or Firefox work best for development.

**Desktop (NW.js)**: Use RPG Maker MZ's playtest feature or launch via NW.js with the project directory as the app path. The `package.json` configures NW.js window settings (816x624, centered).

**Troubleshooting**: If assets fail to load, verify Git LFS is installed (`git lfs install`) and pull LFS objects (`git lfs pull`).

### Version Control

- **Git LFS**: Configured via `.gitattributes` for large binary assets (audio, images, fonts, videos, PSDs)
- **Line Endings**: Normalized to LF via `.gitattributes` to prevent Windows/Mac cross-platform noise
- **Branch Strategy**: Feature branches from `main` following `feature/<name>-<scope>` pattern
- **Commit Style**: Follow [Conventional Commits](https://www.conventionalcommits.org/en/v1.0.0/#summary)
- **Project File**: `game.rmmzproject` identifies this as an RPG Maker MZ v1.9.1 project (used by editor)

### Collaboration Guidelines

**Map Editing**: Avoid concurrent edits to the same `MapXXX.json` file. Coordinate with team members before editing maps, as merge conflicts in map JSON are difficult to resolve.

**Database Changes**: Batch related changes to database files (`Actors.json`, `Classes.json`, etc.) in a single PR when possible to minimize conflicts.

**Plugin Development**:
- Place new JavaScript plugins in `js/plugins/`
- Use RPG Maker's Plugin Manager to enable/disable plugins (this updates `plugins.js`)
- Never manually edit `plugins.js`

**Asset Naming**:
- Use kebab-case, descriptive names (e.g., `inn-exterior.png`, `npc-bartender-01.png`)
- Audio: prefix with type if helpful (e.g., `bgm-town-day.ogg`)
- Keep filenames lowercase
- **Special prefixes** in `img/characters/`:
  - `!` prefix: Fixed direction (non-directional character)
  - `$` prefix: Single character per file (not 8-character sheet)
  - `%` prefix: 3x4 character sheet (smaller format)

### Pull Request Requirements

- Fetch latest `main` before starting work
- Art/audio filenames must be descriptive and lowercase
- Fill out PR checklist in CONTRIBUTING.md
- Requires 1 approval before merge to `main`

### Deployment & Exports

RPG Maker MZ can export standalone builds for Windows, Mac, Linux, Web, iOS, and Android via File > Deployment in the editor. Exported builds go to project-specific output folders.

**Note**: `build/`, `dist/`, and `release/` directories are gitignored. Do not commit compiled/exported game builds to the repository. Distribute builds separately (itch.io, Steam, etc.).

## Game Configuration

- **Title**: Pharmageddon
- **Resolution**: 816x624 pixels
- **Starting Map**: Map001, position (8, 6)
- **Party Members**: Actors 1, 4, 6, 7
- **Battle System**: Front-view (turn-based)
- **Title BGM**: MainTheme
- **Battle BGM**: Battle1

## Common Pitfalls

### Critical Mistakes to Avoid

1. **Forgetting Git LFS setup**
   - Symptom: Game fails to load assets, shows placeholder graphics or errors
   - Fix: Run `git lfs install` then `git lfs pull` to fetch actual binary files
   - LFS tracks: images, audio, fonts, videos, PSD/XCF source files

2. **Editing JSON data files directly**
   - Files in `data/` (Actors.json, Map001.json, System.json, etc.) are **generated by RPG Maker editor**
   - Manual edits will be overwritten when the editor saves
   - **Always use RPG Maker MZ editor** to modify game data, not a text editor

3. **Manually editing `js/plugins.js`**
   - This file is auto-generated by RPG Maker's Plugin Manager
   - Changes will be lost when plugins are enabled/disabled in the editor
   - Always use Plugin Manager UI to manage plugins

4. **Concurrent map editing**
   - Multiple people editing the same `MapXXX.json` simultaneously causes merge conflicts
   - Map JSON is deeply nested and difficult to resolve conflicts in
   - **Coordinate map ownership** before editing; only one person per map at a time

5. **Breaking the script loading order**
   - Scripts must load in the exact sequence defined in `js/main.js`
   - Core files depend on previous files being loaded
   - Don't modify `main.js` unless you understand the dependency chain

6. **Cross-platform line ending issues**
   - Already handled: `.gitattributes` normalizes text files to LF
   - Don't override or disable Git's text normalization
   - Prevents Windows (CRLF) vs Unix (LF) commit noise

## External Resources

- [RPG Maker Web](https://www.rpgmakerweb.com/) - Official site and tutorials
- [RPG Maker MZ Core API](https://developer.rpgmakerweb.com/rpg-maker-mz/index.html) - Complete JavaScript API documentation
- [RPG Maker Tutorials](https://www.rpgmakerweb.com/category/tutorials) - Official learning resources

## Important Notes

- **Do not modify** core RMMZ files (`rmmz_*.js`) unless absolutely necessary
- **Map IDs** are auto-assigned by RPG Maker; maintain external documentation for human-readable map names
- **Data files** (`data/*.json`) must be edited through RPG Maker editor, never manually
- **System.json** contains critical game configuration; changes should be made through RPG Maker editor
- The game uses custom fonts: ensure `mplus-2p-bold-sub.woff` and `Valorax-lg25V.otf` remain in `fonts/`
- **Save files** (`save/`) are currently tracked in git - consider if this is intentional for your team
